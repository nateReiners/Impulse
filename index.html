<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        display: flex;
        justify-content: center;
        margin: 50px;
        padding: 0px;
      }

      #canvas {
        cursor: crosshair;
      }
    </style>
    <script src="https://code.createjs.com/easeljs-0.8.2.min.js"></script>
    <script>
      function init() {
          // Music: http://www.bensound.com
          const music = new Audio("./assets/audio/slowmotion.mp3");
          music.play();
          const breakingGlass = new Audio("./assets/audio/bulb_break.mp3");


           var canvas = document.getElementById('canvas');
           const context = canvas.getContext('2d');
           var stage = new createjs.Stage("canvas");
           canvas.style.background = 'black';

           var stars = 150;
           for (var i = 0; i < stars; i++) {
                x = Math.random() * canvas.offsetWidth;
                y = Math.random() * canvas.offsetHeight;
                let star = new createjs.Shape();
                star.name = "star";
                star.graphics.beginFill("white")
                star.graphics.drawRect(x,y,1,1);
                star.graphics.endFill();
                stage.addChild(star);
            }


           function getMousePos(canvas, evt) {
              var rect = canvas.getBoundingClientRect();
              return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
              };
            }
            canvas.addEventListener('mousemove', function(evt) {
                let mousePos = getMousePos(canvas, evt);
                let userCircle = new createjs.Shape();
                userCircle.time = createjs.Ticker.getTime();
                userCircle.name = "userCircle";
                userCircle.graphics.beginFill("white").drawCircle(1, 1, 6);
                userCircle.size = 2;
                userCircle.x = mousePos.x;
                userCircle.y = mousePos.y;
                stage.addChild(userCircle);

                let tail = new createjs.Shape();
                tail.name = 'tail';
                tail.time = createjs.Ticker.getTime();
                tail.graphics.beginFill("yellow").drawCircle(0, 0, 5);
                tail.graphics.beginStroke("red").drawCircle(0, 0, 5);

                tail.x = mousePos.x;
                tail.y = mousePos.y;
                stage.addChild(tail);

                let blurryFilter = new createjs.BlurFilter(5, 5);
                tail.filters = [blurryFilter];
                let bounds = blurryFilter.getBounds();
                tail.cache(-50 + bounds.x, -50 + bounds.y, 100 + bounds.width, 100 + bounds.height);

            }, false);


            for ( let i = 0; i < 200; i++ ) {
              var circle = new createjs.Shape();
              var sizes = [2, 3, 4];
              var colors = ["#DAF7A6", "#FFC300", "#FF5733", "#C70039", "#900C3F"]
              var size = sizes[Math.floor(Math.random() * sizes.length)];
              var color = colors[Math.floor(Math.random() * colors.length)];
              circle.graphics.beginFill(color).drawCircle(0,0, size);
                //along top (y0 x0-1024)
                circle.x = Math.floor(Math.random() * 1024);
                circle.y = Math.floor(Math.random() * 550) - 550;
              if (size === 2) {
                circle.size = 2;
              } else if (size === 3) {
                circle.size = 3;
              } else {
                circle.size = 4;
              }

              circle.name = "obstacle";
              circle.time = createjs.Ticker.getTime();
              circle.setBounds(circle.x, circle.y, size, size);
              stage.addChild(circle);
            }

           createjs.Ticker.addEventListener("tick", tick);

           function togglePause() {
             var paused = !createjs.Ticker.getPaused();
             createjs.Ticker.setPaused(paused);
             document.getElementById("pauseBtn").value = paused ? "unpause" : "pause";
           }

           function tick(event) {

             function getMousePos(canvas, evt) {
                var rect = canvas.getBoundingClientRect();
                return {
                  x: evt.clientX - rect.left,
                  y: evt.clientY - rect.top
                };
              }

            function checkCollision(obj1, obj2) {
              var dx = obj1.x - obj2.x;
              var dy = obj1.y - obj2.y;
              var distance = Math.sqrt(dx * dy + dy * dy);
              if (distance < (obj1.size/2 + obj2.size/2) && obj2.name === 'obstacle') {
                return true;
              }
              return false;
            };

             for ( let i = 0; i < stage.children.length; i++ ) {
               const currentChild = stage.getChildAt(i);
               if (currentChild.name === 'obstacle') {
                 currentChild.x -= event.delta/1000*100;
                 currentChild.y += event.delta/1000*100;
                 if (currentChild.y > stage.canvas.height ) { currentChild.y = 0 }
                 if (currentChild.x < 0) { currentChild.x = stage.canvas.width; }
                 let currentTime = createjs.Ticker.getTime();
                 let elapsedTime = (currentTime - currentChild.time)/1000;

                 currentChild.x -= (event.delta/1000 * elapsedTime) - (currentChild.size + 1);
                 currentChild.y += (event.delta/1000 * elapsedTime) - (currentChild.size + 1);
               } else if (currentChild.name === 'tail') {
                 let currentTime = createjs.Ticker.getTime();
                 if (currentChild.time < currentTime - 150) {
                   stage.removeChild(currentChild);
                 }
               } else if (currentChild.name === "userCircle") {
                 if (i < stage.children.length - 2) {
                   stage.removeChild(currentChild);
                   for ( let i = 0; i < stage.children.length - 2; i ++ ) {
                     let currentObstacle = stage.getChildAt(i);
                     if (checkCollision(currentChild, currentObstacle)) {
                       breakingGlass.play();
                       console.log("COLLISION DETECTED!");
                     }
                   }
                 }
               }
             }
             stage.update();
           }
         }




    </script>
  </head>

  <body onLoad="init();">
    <input type="button" value="pause" id="pauseBtn" onclick="togglePause();"><br>

    <canvas id="canvas" width="1024" height="550">
    </canvas>
  </body>

</html>
