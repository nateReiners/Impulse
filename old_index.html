<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        display: flex;
        justify-content: center;
        margin: 50px;
      }

      #canvas {
        cursor: crosshair;
      }
    </style>
    <link href="https://fonts.googleapis.com/css?family=Ruslan+Display" rel="stylesheet">
    <script src="https://code.createjs.com/easeljs-0.8.2.min.js"></script>
    <script>
      function init() {
          // Music: http://www.bensound.com
          const music = new Audio("./assets/audio/slowmotion.mp3");
          music.play();
          const breakingGlass = new Audio("./assets/audio/bulb_break.mp3");


           var canvas = document.getElementById('canvas');
           const context = canvas.getContext('2d');
           var stage = new createjs.Stage("canvas");
           canvas.style.background = 'black';

           var stars = 150;
           for (var i = 0; i < stars; i++) {
                x = Math.random() * canvas.offsetWidth;
                y = Math.random() * canvas.offsetHeight;
                let star = new createjs.Shape();
                star.name = "star";
                star.graphics.beginFill("white")
                star.graphics.drawRect(x,y,1,1);
                star.graphics.endFill();
                stage.addChild(star);
            }


           function getMousePos(canvas, evt) {
              var rect = canvas.getBoundingClientRect();
              return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
              };
            }

            window.userCircle = new createjs.Shape();

              window.userCircle.time = createjs.Ticker.getTime();
              window.userCircle.name = "userCircle";
              window.userCircle.graphics.beginFill("#3399ff").drawCircle(1, 1, 5);
              window.userCircle.size = 5;
              stage.addChild(window.userCircle);


            canvas.addEventListener('mousemove', function(evt) {
                let mousePos = getMousePos(canvas, evt);
                window.userCircle.x = mousePos.x;
                window.userCircle.y = mousePos.y;

                let tail = new createjs.Shape();
                tail.name = 'tail';
                tail.time = createjs.Ticker.getTime();
                tail.graphics.beginFill("yellow").drawCircle(0, 0, 1);
                tail.graphics.beginStroke("red").drawCircle(0, 0, 2);
                tail.graphics.beginStroke("yellow").drawCircle(0, 0, 1);

                tail.x = mousePos.x;
                tail.y = mousePos.y;
                stage.addChild(tail);

                let blurryFilter = new createjs.BlurFilter(10, 10, 10);
                tail.filters = [blurryFilter];
                let bounds = blurryFilter.getBounds();
                tail.cache(-50 + bounds.x, -50 + bounds.y, 100 + bounds.width, 100 + bounds.height);

            }, false);


            for ( let i = 0; i < 200; i++ ) {
              var circle = new createjs.Shape();
              var sizes = [2, 3, 4];
              var colors = ["#DAF7A6", "#FFC300", "#FF5733", "#C70039", "#900C3F"]
              var size = sizes[Math.floor(Math.random() * sizes.length)];
              var color = colors[Math.floor(Math.random() * colors.length)];
              circle.graphics.beginFill(color).drawCircle(0,0, size);
                //along top (y0 x0-1024)
                circle.x = Math.floor(Math.random() * 1024);
                circle.y = Math.floor(Math.random() * 550) - 550;
                circle.size = size;

              circle.name = "obstacle";
              circle.time = createjs.Ticker.getTime();
              circle.setBounds(circle.x, circle.y, size, size);
              stage.addChild(circle);
            }

           createjs.Ticker.addEventListener("tick", tick);
           
           function togglePause() {
             var paused = !createjs.Ticker.getPaused();
             createjs.Ticker.setPaused(paused);
             document.getElementById("pauseBtn").value = paused ? "unpause" : "pause";
           }

           function tick(event) {
             let currentTime = createjs.Ticker.getTime();

            function checkCollision(obj1, obj2) {
              if (obj1.name != 'userCircle') {return false};
              if (obj2.name === 'tail') {
                return false;
              } else if (obj2.name === 'userCircle') {
                return false;
              } else if (obj2.name === 'star'){
                return false;
              } else {
                var dx = obj1.x - obj2.x;
                var dy = obj1.y - obj2.y;
                var distance = Math.sqrt(dx * dx + dy * dy);
                if (distance <= (obj1.size + obj2.size) && obj2.name === 'obstacle') {
                  return true;
                }
              }
              return false;
            };
            let mostRecentUserCircle;
            let userCount = 0;
             for ( let i = 0; i < stage.children.length; i++ ) {
               const currentChild = stage.getChildAt(i);

               if (currentChild.name === "userCircle") {
                 userCount += 1;

                 if (i < stage.children.length) {
                   console.log(userCount);
                   for ( let i = 0; i < stage.children.length - 2; i ++ ) {
                     let currentObstacle = stage.getChildAt(i);
                     if (checkCollision(currentChild, currentObstacle)) {
                       console.log("COLLISION DETECTED!");
                       breakingGlass.play();
                       createjs.Ticker.removeEventListener("tick", tick);
                       var text = new createjs.Text("Game Over", "bold 86px Arial", "red");
                       text.x = 290;
                       text.y = 200;
                       var survivalTime = ((currentTime - window.userCircle.time)/10).toFixed(0);
                       var score = new createjs.Text(`Score: ${survivalTime}`, "bold 50px Arial", "white");
                       score.x = 390;
                       score.y = 300;
                       stage.addChild(text);
                       stage.addChild(score);
                     }
                   }
                 }
               } else if (currentChild.name === 'tail') {
                 if (currentChild.time < currentTime - 200) {
                   stage.removeChild(currentChild);
                 }
               } else if (currentChild.name === 'obstacle') {
                 currentChild.x -= event.delta/1000*100;
                 currentChild.y += event.delta/1000*100;
                 if (currentChild.y > stage.canvas.height ) { currentChild.y = 0 }
                 if (currentChild.x < 0) { currentChild.x = stage.canvas.width; }
                 let currentTime = createjs.Ticker.getTime();
                 let elapsedTime = (currentTime - currentChild.time)/1000;

                 currentChild.x -= (event.delta/1000 * elapsedTime) - (currentChild.size + 1);
                 currentChild.y += (event.delta/1000 * elapsedTime) - (currentChild.size + 1);
               }
             }
             stage.update();
           }
         }




    </script>
  </head>

  <body onLoad="init();">
    <canvas id="canvas" width="1024" height="550">
    </canvas>
  </body>

</html>
